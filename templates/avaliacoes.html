{% extends 'base.html' %}
{% block content %}
<div class="card">
    <!-- T√çTULO -->
    <h2 class="section-title">Avalia√ß√µes - {{ paciente.nome }}</h2>

    <!-- NOVO FORMUL√ÅRIO DE AVALIA√á√ÉO -->
    <h3 class="mt-4" style="color: var(--text-color);">Nova Avalia√ß√£o</h3>
    
    <!-- O formul√°rio envia para a rota de cria√ß√£o -->
    <form method="post" action="{{ url_for('avaliacoes.nova_avaliacao', paciente_id=paciente.id) }}">
        
        <!-- SE√á√ÉO 1: MEDIDAS B√ÅSICAS (PESO E ESTATURA) -->
        <div class="row g-3">
            <div class="col-md-6">
                <label for="peso">Peso (kg) <span class="text-danger">*</span></label>
                <input step="0.1" name="peso" type="number" id="peso" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label for="altura">Estatura (cm) <span class="text-danger">*</span></label>
                <input step="0.1" name="altura" type="number" id="altura" class="form-control" required>
            </div>
        </div>

        <!-- SE√á√ÉO 2: PER√çMETROS (RISCO METAB√ìLICO) -->
        <h4 class="mt-4 mb-2" style="color: var(--primary-blue);">Per√≠metros (cm)</h4>
        <div class="row g-3">
            <div class="col-md-6">
                <label>Per√≠metro da Cintura (PC)</label>
                <input step="0.1" name="perim_cintura" type="number" class="form-control">
            </div>
            <div class="col-md-6">
                <label>Per√≠metro do Quadril (PQ)</label>
                <input step="0.1" name="perim_quadril" type="number" class="form-control">
            </div>
            <div class="col-md-6">
                <label>Per√≠metro do Pesco√ßo (PP)</label>
                <input step="0.1" name="perim_pescoco" type="number" class="form-control">
            </div>
            <div class="col-md-6">
                <label>Per√≠metro do Bra√ßo (PB)</label>
                <input step="0.1" name="perim_braco" type="number" class="form-control">
            </div>
        </div>
        
        <!-- SE√á√ÉO 3: DOBRAS CUT√ÇNEAS (COMPOSI√á√ÉO CORPORAL) -->
        <h4 class="mt-4 mb-2" style="color: var(--primary-blue);">Dobras Cut√¢neas (mm)</h4>
        <div class="row g-3">
            <div class="col-md-6 col-lg-3">
                <label>Tricipital (Perif√©rica)</label>
                <input step="0.1" name="dc_tricipital" type="number" class="form-control">
            </div>
            <div class="col-md-6 col-lg-3">
                <label>Bicipital (Perif√©rica)</label>
                <input step="0.1" name="dc_bicipital" type="number" class="form-control">
            </div>
            <div class="col-md-6 col-lg-3">
                <label>Subescapular (Central)</label>
                <input step="0.1" name="dc_subescapular" type="number" class="form-control">
            </div>
            <div class="col-md-6 col-lg-3">
                <label>Supra-il√≠aca (Central)</label>
                <input step="0.1" name="dc_suprailiaca" type="number" class="form-control">
            </div>
        </div>

        <!-- SE√á√ÉO 4: OBSERVA√á√ïES E BOT√ÉO -->
        <h4 class="mt-4 mb-2" style="color: var(--primary-blue);">Observa√ß√µes</h4>
        <label for="observacoes">Notas Adicionais</label>
        <textarea name="observacoes" id="observacoes" class="form-control"></textarea>
        
        <button class="btn mt-4" type="submit">Adicionar Avalia√ß√£o</button>
    </form>

    <h3 class="mt-5" style="color: var(--text-color);">Hist√≥rico de Avalia√ß√µes</h3>
    
    {% if avaliacoes %}
        <div class="table-responsive">
            <table class="table table-striped table-hover mt-3">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Peso (kg)</th>
                        <th>IMC</th>
                        <th>Risco Comorbidade</th>
                        <th>RCE (Cintura/Estatura)</th>
                        <th>RCQ (Cintura/Quadril)</th>
                        <th>√çndice DCC/DCP</th>
                        <th>Op√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                {% for a in avaliacoes %}
                    <tr>
                        <td>{{ a.data.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>{{ a.peso }}</td>
                        <td>{{ a.imc }}</td>
                        <td>{{ a.classificacao_imc_risco }}</td>
                        
                        <!-- RCE (Exibe a classifica√ß√£o colorida se for de risco) -->
                        <td {% if a.rce >= 0.5 %}style="color: #e74c3c; font-weight: bold;"{% endif %}>
                            {{ a.rce }} 
                        </td>
                        
                        <!-- RCQ (Classifica√ß√£o complexa que veio da rota) -->
                        <td>
                            {{ a.rcq }} ({{ a.classificacao_rcq(paciente.sexo) }})
                        </td>
                        
                        <!-- IDC/DCC (Classifica√ß√£o de distribui√ß√£o) -->
                        <td>
                            {{ a.idc_dcp_dcc }} ({{ a.classificacao_idc() }})
                        </td>

                        <!-- üîë CORRE√á√ÉO: Coluna Op√ß√µes com bot√µes em linha -->
                        <td class="d-flex justify-content-start align-items-center gap-2">
                            
                            <!-- Bot√£o Detalhes (Azul Prim√°rio) -->
                            <a href="{{ url_for('avaliacoes.exibir_avaliacao', id=a.id) }}" 
                               class="btn btn-sm btn-action-details" 
                               title="Ver relat√≥rio detalhado">
                                <i class="bi bi-file-earmark-text"></i>
                            </a>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <!-- Bot√£o Excluir (Vermelho de Risco) -->
                            <form method="post" action="{{ url_for('avaliacoes.excluir_avaliacao', id=a.id) }}" 
                                  style="display:inline; margin: 0;" 
                                  onsubmit="return confirm('Deseja realmente excluir esta avalia√ß√£o?')">
                                <button class="btn btn-sm btn-action-delete" type="submit" title="Excluir avalia√ß√£o">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                            
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>Nenhuma avalia√ß√£o cadastrada para {{ paciente.nome }}.</p>
    {% endif %}

    <p class="mt-4"><a class="btn btn-secondary" href="{{ url_for('pacientes.listar_pacientes') }}">Voltar para Pacientes</a></p>
    
    <!-- TABELAS DE REFER√äNCIA R√ÅPIDA SO GAMBIARRA PARA DAR CERTO -->
    <h4 class="mt-5 mb-3 section-title">Tabelas de Refer√™ncia R√°pida</h4>
    <div class="row g-4 justify-content-center">
        
        <div class="col-md-6 col-lg-4">
            <!-- RISCO PC (PER√çMETRO DA CINTURA) -->
            <div class="card ref-card">
                <h5>Risco PC (Cintura)</h5>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em;">
                    <thead style="background-color: var(--primary-blue); color: white;">
                        <tr><th style="padding: 5px; border: 1px solid #ddd;">Sexo</th><th style="padding: 5px; border: 1px solid #ddd;">Risco Aumentado</th><th style="padding: 5px; border: 1px solid #ddd;">Risco Substancialmente Aumentado</th></tr>
                    </thead>
                    <tbody>
                        <tr><td style="padding: 5px; border: 1px solid #ddd;">Homens</td><td style="padding: 5px; border: 1px solid #ddd;">‚â• 94 cm</td><td style="padding: 5px; border: 1px solid #ddd;">‚â• 102 cm</td></tr>
                        <tr><td style="padding: 5px; border: 1px solid #ddd;">Mulheres</td><td style="padding: 5px; border: 1px solid #ddd;">‚â• 80 cm</td><td style="padding: 5px; border: 1px solid #ddd;">‚â• 88 cm</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <!-- RISCO RCE (CINTURA/ESTATURA) -->
            <div class="card ref-card">
                <h5>Risco RCE (Cintura/Estatura)</h5>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em;">
                    <thead style="background-color: var(--primary-blue); color: white;">
                        <tr><th style="padding: 5px; border: 1px solid #ddd;">RCE</th><th style="padding: 5px; border: 1px solid #ddd;">Classifica√ß√£o</th></tr>
                    </thead>
                    <tbody>
                        <tr><td style="padding: 5px; border: 1px solid #ddd;">RCE < 0.5</td><td style="padding: 5px; border: 1px solid #ddd; color: green;">Risco Baixo</td></tr>
                        <tr><td style="padding: 5px; border: 1px solid #ddd;">RCE ‚â• 0.5</td><td style="padding: 5px; border: 1px solid #ddd; color: #e74c3c; font-weight: bold;">Risco Elevado</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <!-- RISCO RCQ (CINTURA/QUADRIL) -->
            <div class="card ref-card">
                <h5>Risco RCQ (Cintura/Quadril)</h5>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em;">
                    <thead style="background-color: var(--primary-blue); color: white;">
                        <tr><th style="padding: 5px; border: 1px solid #ddd;">Sexo</th><th style="padding: 5px; border: 1px solid #ddd;">Risco Elevado</th></tr>
                    </thead>
                    <tbody>
                        <tr><td style="padding: 5px; border: 1px solid #ddd;">Homens</td><td style="padding: 5px; border: 1px solid #ddd;">RCQ > 1.0</td></tr>
                        <tr><td style="padding: 5px; border: 1px solid #ddd;">Mulheres</td><td style="padding: 5px; border: 1px solid #ddd;">RCQ > 0.85</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>

</div>
{% endblock %}